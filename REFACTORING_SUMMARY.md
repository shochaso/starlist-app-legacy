# ğŸ”§ STARLIST MVPãƒªãƒªãƒ¼ã‚¹ ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã‚µãƒãƒªãƒ¼

**ä½œæˆæ—¥**: 2025-11-30  
**å®Ÿæ–½è€…**: AIãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢

---

## ğŸ“‹ ä¿®æ­£å¯¾è±¡ä¸€è¦§

### âœ… å®Œäº†ã—ãŸä¿®æ­£

#### 1. ã‚¬ãƒãƒ£ã‚·ã‚¹ãƒ†ãƒ ã®å®Œå…¨ä¿®æ­£ï¼ˆP0 - ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ï¼‰

##### 1.1 `lib/src/features/gacha/data/gacha_limits_repository.dart`
**ä¿®æ­£å†…å®¹**:
- âœ… ãƒ†ãƒ¼ãƒ–ãƒ«åã‚’`gacha_attempts` â†’ `gacha_daily_attempts`ã«çµ±ä¸€
- âœ… RPCãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åã‚’`user_id_param` â†’ `target_user_id`ã«çµ±ä¸€
- âœ… å¤ã„RPCé–¢æ•°`get_available_gacha_attempts`ã®å‚ç…§ã‚’å‰Šé™¤ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ç›´æ¥å‚ç…§ã«å¤‰æ›´ï¼‰
- âœ… ã‚«ãƒ©ãƒ æ§‹é€ ã®å¤‰æ›´ã«å¯¾å¿œï¼ˆ`base_attempts`/`bonus_attempts`/`used_attempts` â†’ `attempts`ã®ã¿ï¼‰
- âœ… `initialize_daily_gacha_attempts_jst3`ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åä¿®æ­£
- âœ… `consume_gacha_attempt_atomic`ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åä¿®æ­£
- âœ… `date_key`ï¼ˆYYYYMMDDå½¢å¼ï¼‰ã®å‡¦ç†ã‚’è¿½åŠ 

**ä¿®æ­£å‰ã®å•é¡Œ**:
```dart
// âŒ å¤ã„ãƒ†ãƒ¼ãƒ–ãƒ«å
.from('gacha_attempts')

// âŒ å¤ã„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å
'user_id_param': userId

// âŒ å­˜åœ¨ã—ãªã„RPCé–¢æ•°
.rpc('get_available_gacha_attempts')
```

**ä¿®æ­£å¾Œ**:
```dart
// âœ… æ–°ã—ã„ãƒ†ãƒ¼ãƒ–ãƒ«å
.from('gacha_daily_attempts')

// âœ… æ­£ã—ã„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å
'target_user_id': userId

// âœ… ãƒ†ãƒ¼ãƒ–ãƒ«ç›´æ¥å‚ç…§
_getStatsFromTable(userId)
```

##### 1.2 `lib/src/features/gacha/services/ad_service.dart`
**ä¿®æ­£å†…å®¹**:
- âœ… `complete_ad_view_and_grant_ticket`ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ–°ã—ã„ã‚¹ã‚­ãƒ¼ãƒã«åˆã‚ã›ã¦ä¿®æ­£
- âœ… ä¸è¦ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆ`ad_view_id_param`, `device_id_param`, `user_agent_param`ï¼‰ã‚’å‰Šé™¤
- âœ… æˆ»ã‚Šå€¤ã®å‡¦ç†ã‚’ä¿®æ­£ï¼ˆ`void`é–¢æ•°ã®é©åˆ‡ãªå‡¦ç†ï¼‰

**ä¿®æ­£å‰**:
```dart
// âŒ å¤ã„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åã¨ä¸è¦ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
await _supabaseService.rpc('complete_ad_view_and_grant_ticket', params: {
  'user_id_param': userId,
  'ad_view_id_param': adViewId,
  'device_id_param': deviceId,
  'user_agent_param': null,
});
```

**ä¿®æ­£å¾Œ**:
```dart
// âœ… æ–°ã—ã„ã‚¹ã‚­ãƒ¼ãƒã«åˆã‚ã›ãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
await _supabaseService.rpc('complete_ad_view_and_grant_ticket', params: {
  'target_user_id': userId,
});
```

##### 1.3 `lib/src/features/gacha/providers/gacha_attempts_manager.dart`
**ä¿®æ­£å†…å®¹**:
- âœ… `add_gacha_bonus_attempts` RPCé–¢æ•°ã®å‚ç…§ã‚’å‰Šé™¤ï¼ˆæ–°ã—ã„ã‚¹ã‚­ãƒ¼ãƒã«å­˜åœ¨ã—ãªã„ï¼‰
- âœ… åºƒå‘Šè¦–è´ã«ã‚ˆã‚‹å›æ•°è¿½åŠ ã¯`complete_ad_view_and_grant_ticket`ã§å‡¦ç†ã•ã‚Œã‚‹ã“ã¨ã‚’åæ˜ 
- âœ… æ–°ã—ã„ã‚¹ã‚­ãƒ¼ãƒã«åˆã‚ã›ãŸçŠ¶æ…‹ç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯ã«ä¿®æ­£

**ä¿®æ­£å‰**:
```dart
// âŒ å­˜åœ¨ã—ãªã„RPCé–¢æ•°
await client.rpc('add_gacha_bonus_attempts', params: {
  'user_id_param': userId,
  'bonus_count': count,
});
```

**ä¿®æ­£å¾Œ**:
```dart
// âœ… åºƒå‘Šè¦–è´ã¯complete_ad_view_and_grant_ticketã§å‡¦ç†ã•ã‚Œã‚‹
// ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯ä¸»ã«å†…éƒ¨ä½¿ç”¨ã®ãŸã‚ã€æœ€æ–°çµ±è¨ˆã‚’å–å¾—ã—ã¦çŠ¶æ…‹æ›´æ–°
await refreshAttempts();
```

##### 1.4 `lib/src/features/gacha/data/gacha_repository.dart`ï¼ˆæ–°è¦ä½œæˆï¼‰
**ä¿®æ­£å†…å®¹**:
- âœ… ä¿®æ­£ç‰ˆGachaRepositoryã‚’æ­£å¼æ¡ç”¨
- âœ… ã™ã¹ã¦ã®RPCé–¢æ•°ã«`target_user_id`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ 
- âœ… æˆ»ã‚Šå€¤å‹ã‚’æ­£ã—ãå‡¦ç†ï¼ˆ`void`é–¢æ•°ã®é©åˆ‡ãªå‡¦ç†ï¼‰
- âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®è¿½åŠ 
- âœ… ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ 

#### 2. Lintã‚¨ãƒ©ãƒ¼ã®ä¿®æ­£

**ä¿®æ­£å†…å®¹**:
- âœ… `hide Provider`ã®ä¸è¦ãªæŒ‡å®šã‚’å‰Šé™¤ï¼ˆsupabase_flutterã«ã¯ProviderãŒå­˜åœ¨ã—ãªã„ï¼‰

**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**:
- `lib/src/features/gacha/data/gacha_limits_repository.dart`
- `lib/src/features/gacha/services/ad_service.dart`
- `lib/src/features/gacha/providers/gacha_attempts_manager.dart`

---

## ğŸ”„ ä¿®æ­£ç†ç”±

### 1. ã‚¹ã‚­ãƒ¼ãƒä¸æ•´åˆã®è§£æ±º
æ–°ã—ã„ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ`20250722100000_gacha_ads_jst3.sql`ï¼‰ã§å®šç¾©ã•ã‚ŒãŸã‚¹ã‚­ãƒ¼ãƒã¨ã€æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã®å‚ç…§ãŒä¸ä¸€è‡´ã§ã—ãŸã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¬ãƒãƒ£æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã—ãªã„å•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã¾ã—ãŸã€‚

### 2. RPCé–¢æ•°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åã®çµ±ä¸€
Supabase RPCé–¢æ•°ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åãŒ`target_user_id`ã«çµ±ä¸€ã•ã‚Œã¦ã„ã‚‹ã«ã‚‚ã‹ã‹ã‚ã‚‰ãšã€ã‚³ãƒ¼ãƒ‰ã§ã¯`user_id_param`ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã—ãŸã€‚ã“ã‚Œã«ã‚ˆã‚Šã€RPCé–¢æ•°å‘¼ã³å‡ºã—ãŒå¤±æ•—ã—ã¦ã„ã¾ã—ãŸã€‚

### 3. ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã®å¤‰æ›´ã¸ã®å¯¾å¿œ
æ–°ã—ã„ã‚¹ã‚­ãƒ¼ãƒã§ã¯ã€`gacha_attempts`ãƒ†ãƒ¼ãƒ–ãƒ«ãŒ`gacha_daily_attempts`ã«å¤‰æ›´ã•ã‚Œã€ã‚«ãƒ©ãƒ æ§‹é€ ã‚‚ç°¡ç´ åŒ–ã•ã‚Œã¾ã—ãŸï¼ˆ`base_attempts`/`bonus_attempts`/`used_attempts` â†’ `attempts`ã®ã¿ï¼‰ã€‚

---

## ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœ

### ä¿®æ­£å¾Œã®å‹•ä½œç¢ºèªãŒå¿…è¦ãªé …ç›®

1. **ã‚¬ãƒãƒ£å›æ•°å–å¾—**
   - `getGachaAttemptsStats()`ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã‹
   - æ–°ã—ã„ã‚¹ã‚­ãƒ¼ãƒï¼ˆ`gacha_daily_attempts`ï¼‰ã‹ã‚‰æ­£ã—ããƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã‚‹ã‹

2. **ã‚¬ãƒãƒ£å›æ•°æ¶ˆè²»**
   - `consumeGachaAttempt()`ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã‹
   - `consume_gacha_attempt_atomic` RPCé–¢æ•°ãŒæ­£ã—ãå‘¼ã³å‡ºã•ã‚Œã‚‹ã‹

3. **åºƒå‘Šè¦–è´é€£æº**
   - `complete_ad_view_and_grant_ticket`ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã‹
   - åºƒå‘Šè¦–è´å¾Œã«ã‚¬ãƒãƒ£å›æ•°ãŒæ­£ã—ãå¢—åŠ ã™ã‚‹ã‹

4. **æ—¥æ¬¡åˆæœŸåŒ–**
   - `initialize_daily_gacha_attempts_jst3`ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã‹
   - æ–°ã—ã„æ—¥ä»˜ã‚­ãƒ¼ï¼ˆYYYYMMDDå½¢å¼ï¼‰ãŒæ­£ã—ãå‡¦ç†ã•ã‚Œã‚‹ã‹

---

## ğŸš§ æ®‹ã‚Šã®ä¿®æ­£é …ç›®ï¼ˆå„ªå…ˆåº¦é †ï¼‰

### P0: MVPãƒªãƒªãƒ¼ã‚¹å‰ã«å¿…é ˆ

#### 1. èªè¨¼ã‚·ã‚¹ãƒ†ãƒ 
- [ ] OAuthé€£æºå®Ÿè£…ï¼ˆGoogle/Appleï¼‰
- [ ] 401/403ã‚¨ãƒ©ãƒ¼æ™‚ã®å†èªè¨¼ãƒ•ãƒ­ãƒ¼

#### 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ•´åˆæ€§
- [ ] å¤ã„ã‚¹ã‚­ãƒ¼ãƒã®å‰Šé™¤ï¼ˆ`gacha_attempts`ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
- [ ] é‡è¤‡ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®æ•´ç†

#### 3. ãã®ä»–ã®ä¸æ•´åˆ
- [ ] `users`ãƒ†ãƒ¼ãƒ–ãƒ«å‚ç…§ã‚’`profiles`ã«çµ±ä¸€
- [ ] å¤ã„RPCé–¢æ•°ã®å‚ç…§ã‚’å‰Šé™¤

### P1: ãƒªãƒªãƒ¼ã‚¹å¾Œæ—©æœŸå¯¾å¿œ

- [ ] ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒå®Œå…¨å®Ÿè£…
- [ ] ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
- [ ] ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³æ›´æ–°é€šçŸ¥
- [ ] ãƒ‡ãƒ¼ã‚¿å–ã‚Šè¾¼ã¿ç²¾åº¦å‘ä¸Š

---

## ğŸ“ æœ€çµ‚PRèª¬æ˜æ–‡

### ã‚¿ã‚¤ãƒˆãƒ«
`fix: ã‚¬ãƒãƒ£ã‚·ã‚¹ãƒ†ãƒ ã®Supabaseã‚¹ã‚­ãƒ¼ãƒä¸æ•´åˆã‚’ä¿®æ­£`

### èª¬æ˜

#### æ¦‚è¦
æ–°ã—ã„ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ`20250722100000_gacha_ads_jst3.sql`ï¼‰ã§å®šç¾©ã•ã‚ŒãŸã‚¹ã‚­ãƒ¼ãƒã¨æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã®ä¸æ•´åˆã‚’ä¿®æ­£ã—ã¾ã—ãŸã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¬ãƒãƒ£æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

#### ä¸»ãªå¤‰æ›´ç‚¹

1. **ãƒ†ãƒ¼ãƒ–ãƒ«åã®çµ±ä¸€**
   - `gacha_attempts` â†’ `gacha_daily_attempts`ã«å¤‰æ›´
   - ã™ã¹ã¦ã®å‚ç…§ã‚’æ–°ã—ã„ãƒ†ãƒ¼ãƒ–ãƒ«åã«çµ±ä¸€

2. **RPCé–¢æ•°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åã®çµ±ä¸€**
   - `user_id_param` â†’ `target_user_id`ã«å¤‰æ›´
   - ã™ã¹ã¦ã®RPCå‘¼ã³å‡ºã—ã‚’æ–°ã—ã„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åã«çµ±ä¸€

3. **ã‚«ãƒ©ãƒ æ§‹é€ ã®å¤‰æ›´ã¸ã®å¯¾å¿œ**
   - `base_attempts`/`bonus_attempts`/`used_attempts` â†’ `attempts`ã®ã¿
   - æ–°ã—ã„ã‚¹ã‚­ãƒ¼ãƒã«åˆã‚ã›ãŸãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ­ã‚¸ãƒƒã‚¯ã«ä¿®æ­£

4. **å¤ã„RPCé–¢æ•°ã®å‚ç…§ã‚’å‰Šé™¤**
   - `get_available_gacha_attempts`ï¼ˆå­˜åœ¨ã—ãªã„ï¼‰â†’ ãƒ†ãƒ¼ãƒ–ãƒ«ç›´æ¥å‚ç…§
   - `add_gacha_bonus_attempts`ï¼ˆå­˜åœ¨ã—ãªã„ï¼‰â†’ `complete_ad_view_and_grant_ticket`ã‚’ä½¿ç”¨

5. **GachaRepositoryã®æ­£å¼æ¡ç”¨**
   - ä¿®æ­£ç‰ˆGachaRepositoryã‚’æ­£å¼æ¡ç”¨
   - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨nullå®‰å…¨æ€§ã‚’æ”¹å–„

#### ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«
- `lib/src/features/gacha/data/gacha_limits_repository.dart`
- `lib/src/features/gacha/services/ad_service.dart`
- `lib/src/features/gacha/providers/gacha_attempts_manager.dart`
- `lib/src/features/gacha/data/gacha_repository.dart`ï¼ˆæ–°è¦ï¼‰

#### ãƒ†ã‚¹ãƒˆ
- [ ] ã‚¬ãƒãƒ£å›æ•°å–å¾—ã®ãƒ†ã‚¹ãƒˆ
- [ ] ã‚¬ãƒãƒ£å›æ•°æ¶ˆè²»ã®ãƒ†ã‚¹ãƒˆ
- [ ] åºƒå‘Šè¦–è´é€£æºã®ãƒ†ã‚¹ãƒˆ
- [ ] æ—¥æ¬¡åˆæœŸåŒ–ã®ãƒ†ã‚¹ãƒˆ

#### é–¢é€£Issue
- MVP_RELEASE_GAP_ANALYSIS.md #5.1, #5.2, #5.3

#### ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
- [x] ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†
- [x] Lintã‚¨ãƒ©ãƒ¼ä¿®æ­£
- [ ] ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆè¿½åŠ 
- [ ] çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°

---

**ä¿®æ­£å®Œäº†æ—¥**: 2025-11-30  
**æ¬¡å›æ›´æ–°**: æ®‹ã‚Šã®ä¿®æ­£é …ç›®å®Œäº†å¾Œ


