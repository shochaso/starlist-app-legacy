"use strict";(()=>{var e={};e.id=766,e.ids=[766],e.modules={517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7147:e=>{e.exports=require("fs")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},7561:e=>{e.exports=require("node:fs")},4492:e=>{e.exports=require("node:stream")},2477:e=>{e.exports=require("node:stream/web")},1017:e=>{e.exports=require("path")},4577:e=>{e.exports=require("punycode")},2781:e=>{e.exports=require("stream")},7310:e=>{e.exports=require("url")},3837:e=>{e.exports=require("util")},1267:e=>{e.exports=require("worker_threads")},9796:e=>{e.exports=require("zlib")},9201:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>g,originalPathname:()=>E,requestAsyncStorage:()=>f,routeModule:()=>m,serverHooks:()=>b,staticGenerationAsyncStorage:()=>h,staticGenerationBailout:()=>_});var i={};r.r(i),r.d(i,{POST:()=>POST}),r(8976);var o=r(884),n=r(6132),a=r(5798),s=r(4709);let l=process.env.GROQ_API_KEY??"";l||console.warn("GROQ_API_KEY is not configured. Groq completions will fail.");let u=l?new s.ZP({apiKey:l}):null;async function runGroqCompletion(e){if(!u)throw Error("GROQ_API_KEY is not configured.");let t=new AbortController,r=setTimeout(()=>t.abort(),3e4);try{let i=await u.chat.completions.create({model:"llama-3.1-70b-versatile",messages:[{role:"user",content:e}],temperature:.1,response_format:{type:"json_object"}},{signal:t.signal});return clearTimeout(r),i.choices?.[0]?.message?.content}catch(e){if(clearTimeout(r),e instanceof Error&&"AbortError"===e.name)throw Error("Groq API request timed out after 30 seconds");throw e}}let c=[/[\u00A0\r]/g,/(\d+(\.\d+)?)(万|K)?\s*回視聴/g,/【[^】]+】/g,/[\p{Emoji_Presentation}\p{Emoji}\p{Emoji_Modifier_Base}]/gu];function cleanText(e){let t=e??"";return c.forEach(e=>{t=t.replace(e,"")}),t.replace(/\s+/g," ").trim()}let p=process.env.YOUTUBE_API_KEY??"";async function youtubeEnrich(e){let t=await Promise.all(e.map(async e=>{let t=e.videoId.trim();if(!p||!t)return buildFallbackItem(e,!0);let r=new URL("https://www.googleapis.com/youtube/v3/videos");r.searchParams.set("part","snippet,contentDetails"),r.searchParams.set("id",t),r.searchParams.set("key",p);try{let i=await fetch(r.toString());if(!i.ok)return console.error("YouTube API failed",await i.text()),buildFallbackItem(e,!0);let o=await i.json(),n=Array.isArray(o?.items)?o.items[0]:null;if(!n)return buildFallbackItem(e,!0);return{title:e.title,channel:e.channel,time:e.time,videoId:String(n.id??t),duration:function(e){if(!e)return"";let t=Array.from(e.matchAll(/(\d+)([HMS])/g));if(!t.length)return"";let r=0,i=0,o=0;return(t.forEach(e=>{let t=Number(e[1]);switch(e[2]){case"H":r=t;break;case"M":i=t;break;case"S":o=t}}),r)?`${String(r).padStart(2,"0")}:${String(i).padStart(2,"0")}:${String(o).padStart(2,"0")}`:`${String(i).padStart(2,"0")}:${String(o).padStart(2,"0")}`}(n.contentDetails?.duration??""),thumbnails:n.snippet?.thumbnails?.medium??{}}}catch(t){return console.error("YouTube videos.list fetch error",t),buildFallbackItem(e,!0)}}));return t}function buildFallbackItem(e,t=!1){return{title:e.title,channel:e.channel,time:e.time,videoId:t?"":e.videoId.trim(),duration:"",thumbnails:{}}}let d=`
You are an assistant that extracts YouTube watch history from OCR.
OCR:
{OCR_PLACEHOLDER}

Return strict JSON:
{
  "items": [
    {
      "title": "...",
      "channel": "...",
      "time": "12:41" or null,
      "videoId": "" or null
    }
  ]
}
`;function buildErrorResponse(e,t,r){return a.Z.json({error:!0,message:e,raw:r},{status:t})}async function POST(e){let t,r;let i=process.env.GROQ_API_KEY;if(!i)return buildErrorResponse("GROQ_API_KEY is not configured.",401);let o=process.env.YOUTUBE_API_KEY;if(!o)return buildErrorResponse("YOUTUBE_API_KEY is not configured.",401);try{t=await e.json()}catch(e){return buildErrorResponse("Request JSON parse failed",400,e.message)}if(!t?.ocrText)return buildErrorResponse("ocrText field is required.",400);let n=d.replace("{OCR_PLACEHOLDER}",t.ocrText);try{r=await runGroqCompletion(n)}catch(e){return buildErrorResponse("Groq completion failed",502,e.message)}let s=function(e){if("object"!=typeof e||null===e)return null;let t=e.items;if(!Array.isArray(t))return null;let r=[];for(let e of t)"object"==typeof e&&null!==e&&"string"==typeof e.title&&"string"==typeof e.channel&&r.push({title:e.title,channel:e.channel,time:e.time??null,videoId:e.videoId??""});return r.length?r:null}(r);if(!s)return buildErrorResponse("Unexpected Groq response",502,"string"==typeof r?r:JSON.stringify(r??{}));let l=s.map(e=>({title:cleanText(e.title),channel:cleanText(e.channel),time:function(e){if(!e)return null;let t=e.trim(),r=t.match(/(\d{1,2}:)?\d{1,2}:\d{2}/);return r?r[0]:/^\d+分$/.test(t)?t:null}(e.time),videoId:(e.videoId??"").trim()})).filter(e=>e.title&&e.channel),u=await youtubeEnrich(l);return a.Z.json({items:u})}let m=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/youtube-intake/route",pathname:"/api/youtube-intake",filename:"route",bundlePath:"app/api/youtube-intake/route"},resolvedPagePath:"/Users/shochaso/Downloads/starlist-app/app/api/youtube-intake/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:f,staticGenerationAsyncStorage:h,serverHooks:b,headerHooks:g,staticGenerationBailout:_}=m,E="/api/youtube-intake/route"}};var t=require("../../../webpack-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),r=t.X(0,[955,709],()=>__webpack_exec__(9201));module.exports=r})();